@model TodoListApp.WebApp.Models.TaskDetails
@{
    ViewData["Title"] = "Task";
}

@{
    string statusClass = Model.Status switch
    {
        TodoListApp.WebApp.Models.TaskStatus.NotStarted => "notstarted",
        TodoListApp.WebApp.Models.TaskStatus.InProgress => "inprogress",
        TodoListApp.WebApp.Models.TaskStatus.Completed => "completed",
        _ => ""
    };

    var overdue = ((Model.IsOverdue ?? (Model.DueDate.HasValue && Model.DueDate.Value < DateTime.UtcNow))
                  && Model.Status != TodoListApp.WebApp.Models.TaskStatus.Completed);
}
<div class="mb-2">
    <span class="badge badge-status @statusClass">@Model.Status</span>
    @if (overdue)
    {
        <span class="ms-2 small fw-semibold" style="color:#b91c1c;">Overdue</span>
    }
</div>

<div class="page-title">
    <h1>@Model.Title</h1>
</div>
@if (!string.IsNullOrWhiteSpace(Model.Description))
{
    <div class="desc mb-3">@Model.Description</div>
}

<div class="card border-0 shadow-sm">
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">Task Id</dt>
            <dd class="col-sm-9">@Model.Id</dd>

            <dt class="col-sm-3">List Id</dt>
            <dd class="col-sm-9">@Model.TodoListId</dd>

            <dt class="col-sm-3">Created</dt>
            <dd class="col-sm-9">@Model.CreatedDate.ToString("yyyy-MM-dd HH:mm")</dd>

            <dt class="col-sm-3">Due</dt>
            <dd class="col-sm-9">@((Model.DueDate.HasValue) ? Model.DueDate.Value.ToString("yyyy-MM-dd HH:mm") : "-")</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">@Model.Status</dd>

            <dt class="col-sm-3">Assignee</dt>
            <dd class="col-sm-9">@(!string.IsNullOrWhiteSpace(Model.AssigneeId) ? Model.AssigneeId : "-")</dd>

            @if (Model.IsOverdue.HasValue)
            {
                <dt class="col-sm-3">Overdue</dt>
                <dd class="col-sm-9">@(Model.IsOverdue.Value ? "Yes" : "No")</dd>
            }
        </dl>
    </div>
</div>

@{
    var taskTags = ViewData["TaskTags"] as IReadOnlyList<TodoListApp.WebApp.Models.TagItem> ?? Array.Empty<TodoListApp.WebApp.Models.TagItem>();
    var allTags = ViewData["AllTags"] as IReadOnlyList<TodoListApp.WebApp.Models.TagItem> ?? Array.Empty<TodoListApp.WebApp.Models.TagItem>();
}

<div class="mt-3">
    <h5>Tags</h5>
    <div class="d-flex flex-wrap gap-2">
        @foreach (var t in taskTags)
        {
            <form asp-action="RemoveTag" method="post"
                  class="d-inline-flex align-items-center gap-2"
                  style="background:@t.ColorHex; border-radius:999px; padding:4px 10px;">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />
                <input type="hidden" name="tagId" value="@t.Id" />

                <span style="font-size:13px;">@t.Name</span>

                <button type="submit"
                        style="border:none; background:transparent; font-size:12px; line-height:1; cursor:pointer;">
                    âœ•
                </button>
            </form>

        }
    </div>

    <form asp-action="AddTag" method="post" class="mt-2 d-flex gap-2 align-items-center">
        @Html.AntiForgeryToken()
        <input type="hidden" name="id" value="@Model.Id" />
        <select name="tagId" class="form-select form-select-sm" style="width:180px;">
            @foreach (var t in allTags)
            {
                <option value="@t.Id">@t.Name</option>
            }
        </select>
        <button type="submit" class="btn btn-primary btn-sm">Add tag</button>
    </form>
</div>

<div class="mt-3">
    <a asp-controller="TodoList" asp-action="Index"
       asp-route-selectedId="@Model.TodoListId"
       asp-route-selectedTitle=""
       asp-route-selectedDescription=""
       class="btn btn-outline-secondary square-btn">Back</a>
</div>
